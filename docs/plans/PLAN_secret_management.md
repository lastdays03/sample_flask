# 구현 계획: 비밀 키 관리 강화 (Secret Management Enforcement)

**상태**: ✅ 완료
**시작일**: 2025-12-25
**최종 수정일**: 2025-12-25
**예상 완료일**: 2025-12-25

---

**⚠️ 중요 지침**: 각 단계 완료 후:
1. ✅ 완료된 태스크 체크박스 표시
2. 🧪 모든 품질 게이트 검증 명령어 실행
3. ⚠️ 모든 품질 게이트 항목 통과 확인
4. 📅 상단의 "최종 수정일" 업데이트
5. 📝 노트 섹션에 배운 점 기록
6. ➡️ 그 후 다음 단계로 진행

⛔ **품질 게이트를 건너뛰거나 검사가 실패한 상태로 진행하지 마십시오**

---

## 📋 개요

### 기능 설명
이 기능은 애플리케이션이 `production` 설정으로 실행될 때 `SECRET_KEY` 환경 변수의 존재를 강제합니다. 프로덕션 환경에서 `SECRET_KEY`가 누락된 경우, 기본값을 사용하는 대신 애플리케이션 시작을 실패(에러 발생)하게 만듭니다. 이는 프로덕션에서 취약하거나 알려진 기본 비밀 키를 사용하는 보안 취약점을 방지합니다.

### 성공 기준
- [x] `ProductionConfig`는 환경 변수에 `SECRET_KEY`가 설정되지 않은 경우 `ValueError` (또는 유사한 에러)를 발생시켜야 함.
- [x] `ProductionConfig`는 `SECRET_KEY`가 설정된 경우 정상적으로 로드되어야 함.
- [x] `DevelopmentConfig` 및 `TestingConfig`는 기본/대체 키로 계속 작동하거나 이 검사를 강제하지 않아야 함.

### 사용자 영향
- **보안**: 프로덕션에서 안전하지 않은 기본 비밀 키 사용을 방지하여 보안을 크게 향상시킵니다.
- **운영(Ops)**: 설정이 누락된 경우 배포가 즉시 실패하여 운영팀에 알립니다.

---

## 🏗️ 아키텍처 결정

| 결정 | 근거 | 트레이드오프 |
|----------|-----------|------------|
| **Config 클래스 내 강제화** | 설정 로직을 중앙 집중화합니다. `Config` 객체가 진실의 원천(source of truth)입니다. | `import os`가 필요함 (이미 존재). 변경이 간단함. |
| **ValueError 발생** | 잘못된 값에 대한 표준 Python 예외입니다. 의미가 명확합니다. | 앱 시작 시 크래시 발생 (의도됨). |
| **init_app 패턴 도입** | 클래스 로딩 시점이 아닌 앱 생성 시점에 환경변수를 검증하기 위해 도입했습니다. | `app/__init__.py` 수정 필요. 더 명시적이고 안전함. |

---

## 🛡️ 예외 처리 전략

| 시나리오 | 예상치 못한 동작 | 처리 전략 | 사용자 피드백 |
|----------|---------------------|-------------------|---------------|
| **SECRET_KEY 누락 (Prod)** | 앱 시작 실패. | 즉시 `ValueError` 발생. | 로그: "SECRET_KEY environment variable is required in production." |
| **SECRET_KEY 누락 (Dev)** | 기본 키로 앱 시작. | 기본 문자열로 대체. | 없음 (선택적으로 경고). |

---

## 📦 의존성

### 시작 전 필요 사항
- 없음. 표준 Python 라이브러리 (`os`).

---

## 🧪 테스트 전략

### 테스트 접근 방식
**TDD 원칙**: `SECRET_KEY`를 설정하지 않고 `ProductionConfig`를 생성하려고 시도할 때 에러가 발생하는지 명시적으로 확인하는 단위 테스트를 먼저 작성합니다.

### 이 기능을 위한 테스트 피라미드
| 테스트 유형 | 커버리지 목표 | 목적 |
|-----------|-----------------|---------|
| **단위 테스트 (Unit Tests)** | 100% | Config 클래스 동작 직접 검증. |

### 테스트 파일 구조
```
tests/
└── unit/
    └── test_app_config.py  <-- 기존 파일 확장
```

---

## 🚀 구현 단계

### 1단계: 보안 강제화 (Security Enforcement)
**목표**: ProductionConfig에서 `SECRET_KEY` 존재 강제.
**예상 시간**: 1시간
**상태**: ✅ 완료

#### 태스크

**🔴 RED: 실패하는 테스트 먼저 작성**
- [x] **Test 1.1**: `ProductionConfig`가 `SECRET_KEY`를 검증하는지 확인.
  - 파일: `tests/unit/test_app_config.py`
  - 예상: `ProductionConfig`가 현재 기본값으로 대체되므로 테스트 실패 (Red).
  - 상세:
    - 테스트 케이스 A: `SECRET_KEY` 미설정 시 `ProductionConfig`가 `ValueError` 발생.
    - 테스트 케이스 B: `SECRET_KEY` 설정 시 `ProductionConfig` 정상 작동.
    - 테스트 케이스 C: `SECRET_KEY` 미설정 시 `DevelopmentConfig` 정상 작동 (대체값 확인).

**🟢 GREEN: 테스트 통과를 위한 구현**
- [x] **Task 1.2**: `config.py` 업데이트.
  - 파일: `config.py`
  - 목표: Test 1.1 통과.
  - 상세:
    - `ProductionConfig`에서 `init_app` 메서드 구현.
    - 누락 시 `ValueError("SECRET_KEY environment variable is required in production")` 발생.
    - 다른 설정(Dev/Test)이 올바르게 상속/재정의되는지 확인 (기본값 유지).

**🔵 REFACTOR: 코드 정리**
- [x] **Task 1.3**: 코드 품질을 위한 리팩토링.
  - 파일: `config.py`, `tests/unit/test_app_config.py`
  - 목표: 깔끔한 구현 보장.
  - 체크리스트:
    - [x] 에러 메시지가 명확한지 확인.
    - [x] 개발 모드(Development mode)에서 회귀(regression)가 없는지 확인.

#### 품질 게이트 ✋

**⚠️ 중지: 모든 검사가 통과할 때까지 2단계로 진행하지 마십시오**

**TDD 준수**:
- [x] **Red 단계**: 테스트가 먼저 작성되었고 처음에 실패했음.
- [x] **Green 단계**: 최소한의 코드로 구현됨.
- [x] **커버리지 확인**: `config.py` 변경 사항에 대해 100%.

**검증 명령어**:
```bash
# 단위 테스트 실행
make test
# 또는 직접 실행:
pytest tests/unit/test_app_config.py
```

---

## ⚠️ 리스크 평가

| 리스크 | 발생 확률 | 영향도 | 완화 전략 |
|------|-------------|--------|---------------------|
| **배포 중단 (Deployment Breakage)** | 중간 | 높음 | 변경 사항 공지. 배포 파이프라인에 환경 변수가 설정되어 있는지 확인. |

---

## 🔄 롤백 전략

### 1단계 실패 시
**되돌리기 단계**:
- `config.py` 변경 사항 되돌리기.
- `app/__init__.py` 변경 사항 되돌리기.
- `tests/unit/test_app_config.py` 변경 사항 되돌리기.

---

## 📊 진행 상황 추적

### 완료 상태
- **1단계**: ✅ 100%

---
