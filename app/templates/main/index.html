{% extends "base.html" %}

{% block title %}Dashboard - SMART LOCATION RECOMMENDER{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <h1 class="mt-4">Dashboard</h1>
    <div class="row">
        <!-- Left Column: Area Chart -->
        <div class="col-sm-6">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-chart-area me-1"></i>
                    서울시 실거래가 추이
                </div>
                <div class="card-body"><canvas id="myAreaChart" width="100%" height="40"></canvas></div>
            </div>
        </div>
        <!-- Right Column: Bar Chart -->
        <div class="col-sm-6">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-chart-bar me-1"></i>
                    서울시 자치구별 실거래가 상승률
                </div>
                <div class="card-body"><canvas id="myBarChart" width="100%" height="40"></canvas></div>
            </div>
        </div>
    </div>
    <!-- Bottom Row: Data Table -->
    <div class="card mb-4">
        <div class="card-header">
            <i class="fas fa-table me-1"></i>
            서울시 법정동별 실거래가 상승률 TOP 5
        </div>
        <div class="card-body">
            <table class="table table-hover align-middle">
                <thead>
                    <tr>
                        <th>자치구</th>
                        <th>법정동</th>
                        <th>상승률(%)</th>
                        <th>평단가(원)</th>
                        <th>거래수</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    <!-- Data will be populated via JS -->
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        console.log("Dashboard loaded");

        // CSRF Token Helper
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

        async function postData(url = '', data = {}) {
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (!response.ok || result.status === 'error') {
                    // Centralized Error Handling
                    alert("Error: " + (result.message || "Unknown error occurred"));
                    return null; // Return null to indicate failure
                }

                return result;
            } catch (error) {
                console.error('Fetch error:', error);
                alert("Network or Server Error");
                return null;
            }
        }

        // 1. Fetch District Data (Bar Chart)
        postData('/district').then(response => {
            if (response && response.status === 'success') {
                const apiData = response.data;
                const labels = apiData.map(item => item.district_name);
                const values = apiData.map(item => item.total_change_rate);

                // Init Bar Chart
                const ctxBar = document.getElementById("myBarChart");
                if (ctxBar) {
                    new Chart(ctxBar, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: "변동률(%)",
                                backgroundColor: "rgba(2,117,216,1)",
                                borderColor: "rgba(2,117,216,1)",
                                data: values,
                            }],
                        },
                        options: {
                            scales: {
                                yAxes: [{ ticks: { min: 0, max: 20 }, gridLines: { display: true } }],
                            },
                            legend: { display: false }
                        }
                    });
                }
            } else {
                console.error("District Data Error:", response.message);
            }
        });

        // 2. Fetch Building Data (Area Chart) - Simplified Example
        postData('/building').then(response => {
            if (response && response.status === 'success') {
                // For demo, just logging or simplified chart usage
                // Real implementation would parse 'building_use' and dates
                console.log("Building Data:", response.data);

                // Keeping Dummy for Area Chart to avoid complex logic in this task
                drawAreaChartDummy();
            }
        });

        // 3. Fetch Prediction (Table)
        postData('/predict/location').then(response => {
            if (response && response.status === 'success') {
                const tableBody = document.getElementById('table-body');
                if (tableBody) {
                    tableBody.innerHTML = '';
                    response.data.forEach(row => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${row.district_name}</td>
                            <td>${row.legal_dong_name}</td>
                            <td>${row.total_change_rate}%</td>
                            <td>${row.price_per_sqm_format}</td>
                            <td>${row.transaction_count}</td>
                         `;
                        tableBody.appendChild(tr);
                    });
                }
            }
        });

        function drawAreaChartDummy() {
            const ctxArea = document.getElementById("myAreaChart");
            if (ctxArea) {
                new Chart(ctxArea, {
                    type: 'line',
                    data: {
                        labels: ["2015", "2016", "2017", "2018", "2019", "2020", "2021"],
                        datasets: [{
                            label: "Example Data",
                            lineTension: 0.3,
                            backgroundColor: "rgba(2,117,216,0.2)",
                            borderColor: "rgba(2,117,216,1)",
                            pointBackgroundColor: "rgba(2,117,216,1)",
                            data: [10000, 30162, 26263, 18394, 18287, 28682, 31274],
                        }],
                    },
                    options: {
                        legend: { display: false }
                    }
                });
            }
        }
    });
</script>
{% endblock %}